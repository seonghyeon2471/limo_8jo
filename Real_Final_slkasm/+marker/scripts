#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
LKAS + SLAM Guard + Marker Stop (ID 0 â†’ 3s, ID 4 â†’ 5s)
- SLAM(cmd_vel_slam) ë”°ë¼ê°
- LKAS offset â‰¥ depart_threshold â†’ ì œìë¦¬ íšŒì „
- AR ë§ˆì»¤(ID=0,4) ì¸ì‹ ì‹œ ê°•ì œ ì •ì§€ + ì¬ë°œë™ ë°©ì§€ ì¿¨ë‹¤ìš´ í¬í•¨
"""

import rospy
from geometry_msgs.msg import Twist
from std_msgs.msg import Float32, Bool
from ar_track_alvar_msgs.msg import AlvarMarkers   # â˜… ë§ˆì»¤ íŒ¨í‚¤ì§€
import threading


class EWMA(object):
    def __init__(self, alpha=0.6, init_val=0.0):
        self.a = float(alpha)
        self.y = float(init_val)
        self.initialized = False

    def reset(self, v=0.0):
        self.y = float(v)
        self.initialized = True

    def filt(self, x):
        x = float(x)
        if not self.initialized:
            self.reset(x)
        self.y = self.a * self.y + (1.0 - self.a) * x
        return self.y


class LkasSlamGuard(object):
    def __init__(self):
        rospy.init_node("lkas_slam_guard")

        # ===== PARAMETERS =====
        self.rate_hz = rospy.get_param("~rate", 20)

        self.slam_cmd_topic = rospy.get_param("~slam_cmd_topic", "/cmd_vel_slam")
        self.out_cmd_topic  = rospy.get_param("~out_cmd_topic",  "/cmd_vel")

        self.depart_threshold = rospy.get_param("~depart_threshold", 0.25)
        self.clear_threshold  = rospy.get_param("~clear_threshold",  0.15)

        self.lane_gain = rospy.get_param("~lane_gain", 1.2)
        self.max_ang   = rospy.get_param("~max_ang",   1.2)
        self.deadzone  = rospy.get_param("~deadzone",  0.05)

        self.slam_timeout = rospy.get_param("~slam_timeout", 0.5)
        self.lane_timeout = rospy.get_param("~lane_timeout", 0.5)

        # ===== STATE =====
        self.lock = threading.RLock()
        self.last_slam_cmd = Twist()
        self.last_slam_time = 0.0

        self.lane_offset = 0.0
        self.lane_valid = False
        self.last_lane_time = 0.0

        self.in_override = False

        self.f_ang = EWMA(alpha=0.6, init_val=0.0)

        # ===== MARKER STOP STATE =====
        self.is_stopping = False
        self.stop_until = rospy.Time(0)

        # ë§ˆì»¤ë³„ ì¿¨ë‹¤ìš´(ID 0, 4)
        self.cooldown_until = {0: rospy.Time(0), 4: rospy.Time(0)}

        # ===== ROS IO =====
        self.pub_cmd = rospy.Publisher(self.out_cmd_topic, Twist, queue_size=1)
        rospy.Subscriber(self.slam_cmd_topic, Twist, self.cb_slam)
        rospy.Subscriber("/lane_center_offset", Float32, self.cb_offset)
        rospy.Subscriber("/lane_center_valid",  Bool,    self.cb_valid)
        rospy.Subscriber("/ar_pose_marker", AlvarMarkers, self.cb_marker)  # â˜… ì¶”ê°€

        rospy.loginfo("[LKAS_GUARD] READY + Marker Stop Enabled")

        self.spin()

    # =================================
    # CALLBACKS
    # =================================
    def cb_slam(self, msg):
        with self.lock:
            self.last_slam_cmd = msg
            self.last_slam_time = rospy.get_time()

    def cb_offset(self, msg):
        self.lane_offset = msg.data
        self.last_lane_time = rospy.get_time()

    def cb_valid(self, msg):
        self.lane_valid = msg.data

    # =================================
    # ğŸ“Œ Marker callback
    # =================================
    def cb_marker(self, msg):

        # ì´ë¯¸ ì •ì§€ ì¤‘ì´ë©´ ë¬´ì‹œ (ë¬´í•œì • ë©ˆì¶¤ ë°©ì§€)
        if self.is_stopping:
            return

        if len(msg.markers) == 0:
            return

        now = rospy.Time.now()

        for m in msg.markers:
            mid = m.id

            # ê´€ì‹¬ ID
            if mid not in [0, 4]:
                continue

            # ì¿¨ë‹¤ìš´ ì¤‘ì´ë©´ ë¬´ì‹œ
            if now < self.cooldown_until[mid]:
                continue

            # ---- ID 0ë²ˆ: 3ì´ˆ ì •ì§€ ----
            if mid == 0:
                rospy.loginfo("[AR Marker] ID 0 detected â†’ Stop 3 sec")
                self.stop_until = now + rospy.Duration(3.0)
                self.is_stopping = True
                self.cooldown_until[0] = now + rospy.Duration(7.0)  # ì •ì§€ 3 + ì¿¨ë‹¤ìš´ 4
                return

            # ---- ID 4ë²ˆ: 5ì´ˆ ì •ì§€ ----
            if mid == 4:
                rospy.loginfo("[AR Marker] ID 4 detected â†’ Stop 5 sec")
                self.stop_until = now + rospy.Duration(5.0)
                self.is_stopping = True
                self.cooldown_until[4] = now + rospy.Duration(11.0)  # ì •ì§€ 5 + ì¿¨ë‹¤ìš´ 6
                return

    # =================================
    # MAIN LOOP
    # =================================
    def spin(self):
        r = rospy.Rate(self.rate_hz)

        while not rospy.is_shutdown():
            now = rospy.get_time()

            # ---------------------------
            # ğŸš¨ 1) ë§ˆì»¤ ì •ì§€ ìš°ì„ 
            # ---------------------------
            if rospy.Time.now() < self.stop_until:
                stop = Twist()
                stop.linear.x = 0.0
                stop.angular.z = 0.0
                self.pub_cmd.publish(stop)
                r.sleep()
                continue

            # ì •ì§€ ëë‚˜ë©´ í’€ê¸°
            if self.is_stopping and rospy.Time.now() >= self.stop_until:
                rospy.loginfo("[Marker] Stop finished â†’ Resume")
                self.is_stopping = False

            # ---------------------------
            # 2) SLAM timeout â†’ STOP
            # ---------------------------
            with self.lock:
                slam = self.last_slam_cmd
                age_slam = now - self.last_slam_time
                age_lane = now - self.last_lane_time

            cmd = Twist()

            if age_slam > self.slam_timeout:
                self.in_override = False
                self.pub_cmd.publish(cmd)
                r.sleep()
                continue

            # ê¸°ë³¸ = SLAM
            cmd = slam

            # ---------------------------
            # 3) LKAS íŒë‹¨
            # ---------------------------
            lane_ok = (age_lane <= self.lane_timeout) and self.lane_valid
            offset = self.lane_offset

            if lane_ok:
                if abs(offset) >= self.depart_threshold:
                    self.in_override = True
                elif abs(offset) <= self.clear_threshold:
                    self.in_override = False
            else:
                self.in_override = False

            # ---------------------------
            # 4) LKAS Override
            # ---------------------------
            if self.in_override and lane_ok:

                cmd.linear.x = 0.0  # ì¦‰ì‹œ ì •ì§€

                ang = self.lane_gain * offset
                if abs(ang) < self.deadzone:
                    ang = 0.0

                ang = max(-self.max_ang, min(self.max_ang, ang))
                ang = self.f_ang.filt(ang)

                cmd.angular.z = ang

                self.pub_cmd.publish(cmd)
                r.sleep()
                continue

            # ---------------------------
            # 5) ì •ìƒ SLAM ì£¼í–‰
            # ---------------------------
            cmd.angular.z = self.f_ang.filt(cmd.angular.z)
            self.pub_cmd.publish(cmd)
            r.sleep()


if __name__ == "__main__":
    LkasSlamGuard()
