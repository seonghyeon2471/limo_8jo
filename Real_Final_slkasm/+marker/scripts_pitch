#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
LKAS + SLAM Guard + IMU 기반 방지턱 감속 (단순/확실 버전)

- SLAM(/cmd_vel_slam) 기본 추종
- LKAS:
    - /lane_center_offset, /lane_center_valid 사용
    - 이탈 시: 정지 + 제자리 회전
    - 복귀 시: SLAM으로 원복
- IMU:
    - /imu 또는 /imu/data 에서 accel 기반 pitch(deg) 계산
    - |pitch| >= bump_pitch_deg 이면 bump 모드 ON
    - bump 모드 동안 선속도 |linear.x| 를 bump_speed_max 로 클램프
"""

import rospy
from geometry_msgs.msg import Twist
from std_msgs.msg import Float32, Bool
from sensor_msgs.msg import Imu
import threading
import math


class EWMA(object):
    def __init__(self, alpha=0.6, init_val=0.0):
        self.a = float(alpha)
        self.y = float(init_val)
        self.initialized = False

    def reset(self, v=0.0):
        self.y = float(v)
        self.initialized = True

    def filt(self, x):
        x = float(x)
        if not self.initialized:
            self.reset(x)
        self.y = self.a * self.y + (1.0 - self.a) * x
        return self.y


class LkasSlamGuard(object):
    def __init__(self):
        rospy.init_node("lkas_slam_guard")

        # ===== 기본 파라미터 =====
        self.rate_hz = rospy.get_param("~rate", 20)

        self.slam_cmd_topic = rospy.get_param("~slam_cmd_topic", "/cmd_vel_slam")
        self.out_cmd_topic  = rospy.get_param("~out_cmd_topic",  "/cmd_vel")

        self.depart_threshold = rospy.get_param("~depart_threshold", 0.25)
        self.clear_threshold  = rospy.get_param("~clear_threshold",  0.15)

        self.lane_gain = rospy.get_param("~lane_gain", 1.2)
        if rospy.has_param("~yaw_gain"):
            # launch 에서 yaw_gain 으로 넘겨줄 수도 있으니 호환
            self.lane_gain = rospy.get_param("~yaw_gain")

        self.max_ang   = rospy.get_param("~max_ang",   0.9)
        self.deadzone  = rospy.get_param("~deadzone",  0.05)

        self.slam_timeout = rospy.get_param("~slam_timeout", 0.5)
        self.lane_timeout = rospy.get_param("~lane_timeout", 0.5)

        # ===== IMU / 방지턱 관련 파라미터 =====
        self.imu_timeout = rospy.get_param("~imu_timeout", 0.5)   # IMU 유효 시간

        # |pitch| 이 이 값 이상이면 감속 모드 (deg)
        self.bump_pitch_deg = rospy.get_param("~bump_pitch_deg", 8.0)
        # 감속 모드일 때 선속도 최대값 (m/s)
        self.bump_speed_max = rospy.get_param("~bump_speed_max", 0.06)
        # 감속 모드 최소 유지 시간 (sec)
        self.bump_hold_time = rospy.get_param("~bump_hold_time", 0.7)

        # ===== 상태 =====
        self.lock = threading.RLock()

        # SLAM
        self.last_slam_cmd = Twist()
        self.last_slam_time = 0.0

        # LKAS
        self.lane_offset = 0.0
        self.lane_valid = False
        self.last_lane_time = 0.0
        self.in_override = False

        # 조향 필터
        self.f_ang = EWMA(alpha=0.6, init_val=0.0)

        # IMU / pitch
        self.pitch_deg = 0.0
        self.last_imu_time = 0.0
        self.f_pitch = EWMA(alpha=0.5, init_val=0.0)

        # 범프 모드
        self.bump_active = False
        self.bump_release_time = 0.0

        # ===== ROS IO =====
        self.pub_cmd = rospy.Publisher(self.out_cmd_topic, Twist, queue_size=1)

        rospy.Subscriber(self.slam_cmd_topic, Twist, self.cb_slam)
        rospy.Subscriber("/lane_center_offset", Float32, self.cb_offset)
        rospy.Subscriber("/lane_center_valid",  Bool,    self.cb_valid)

        # /imu /imu/data 둘 다 구독해서 토픽 이름 문제 피하기
        rospy.Subscriber("/imu", Imu, self.cb_imu)
        rospy.Subscriber("/imu/data", Imu, self.cb_imu)

        rospy.loginfo("[LKAS_GUARD] READY (LKAS + SLAM + IMU bump slow)")

        self.spin()

    # =================================
    # CALLBACKS
    # =================================
    def cb_slam(self, msg):
        with self.lock:
            self.last_slam_cmd = msg
            self.last_slam_time = rospy.get_time()

    def cb_offset(self, msg):
        with self.lock:
            self.lane_offset = msg.data
            self.last_lane_time = rospy.get_time()

    def cb_valid(self, msg):
        with self.lock:
            self.lane_valid = msg.data

    def cb_imu(self, msg):
        # accel 기반 pitch 계산
        ax = msg.linear_acceleration.x
        ay = msg.linear_acceleration.y
        az = msg.linear_acceleration.z

        pitch = math.atan2(ax, math.sqrt(ay * ay + az * az))
        pitch_deg = pitch * 180.0 / math.pi

        pitch_deg = self.f_pitch.filt(pitch_deg)
        now = rospy.get_time()

        with self.lock:
            self.pitch_deg = pitch_deg
            self.last_imu_time = now

    # =================================
    # MAIN LOOP
    # =================================
    def spin(self):
        r = rospy.Rate(self.rate_hz)

        while not rospy.is_shutdown():
            now = rospy.get_time()

            # 상태 복사
            with self.lock:
                slam
