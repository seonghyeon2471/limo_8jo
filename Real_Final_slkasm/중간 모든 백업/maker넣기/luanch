<launch>

  <!-- ========================================================= -->
  <!-- 1) LIMO ë³¸ì²´ -->
  <!-- ========================================================= -->
  <include file="$(find limo_bringup)/launch/limo_start.launch">
    <arg name="pub_odom_tf" value="false"/>
  </include>

  <!-- ========================================================= -->
  <!-- 2) ì¹´ë©”ë¼ -->
  <!-- ========================================================= -->
  <include file="$(find astra_camera)/launch/dabai_u3.launch"/>

  <!-- ========================================================= -->
  <!-- 3) Navigation (move_base + costmaps) -->
  <!-- ========================================================= -->
  <include file="$(find limo_bringup)/launch/limo_navigation_diff.launch"/>

  <!-- ========================================================= -->
  <!-- 4) LKAS (Lane Center Detection) -->
  <!-- ========================================================= -->
  <node pkg="limo_slam_lkas"
        type="lane_center_bev.py"
        name="lane_center_bev"
        output="screen">
    <param name="image_topic" value="/camera/rgb/image_raw"/>
  </node>

  <!-- ========================================================= -->
  <!-- 4-1) AR TRACK ALVAR (ë§ˆì»¤ ì¸ì‹) -->
  <!-- ========================================================= -->
  <node pkg="ar_track_alvar"
        type="individualMarkersNoKinect"
        name="ar_track_alvar"
        output="screen">

    <!-- í•„ìˆ˜ remap -->
    <remap from="camera_image" to="/camera/rgb/image_raw"/>
    <remap from="camera_info"  to="/camera/rgb/camera_info"/>

    <!-- ë§ˆì»¤ í¬ê¸° (m ë‹¨ìœ„, ì‹¤ì œ ì¶œë ¥ë¬¼ ê¸°ì¤€) -->
    <param name="marker_size" value="0.10"/>  <!-- 10cm -->

    <!-- ì„±ëŠ¥ ì•ˆì •í™” -->
    <param name="max_frequency" value="10.0"/>
    <param name="max_new_marker_error" value="0.08"/>
    <param name="max_track_error" value="0.2"/>
  </node>

  <!-- ========================================================= -->
  <!-- 5) LKAS + SLAM Guard (â­ LEFT-BIASED + DELAYED MARKER STOP) -->
  <!-- ========================================================= -->
  <node pkg="limo_slam_lkas"
        type="lkas_slam_guard.py"
        name="lkas_slam_guard"
        output="screen">

    <!-- ê¸°ë³¸ í† í”½ -->
    <param name="slam_cmd_topic" value="/cmd_vel_slam"/>
    <param name="out_cmd_topic"  value="/cmd_vel"/>

    <!-- LKAS ENABLE -->
    <param name="enable_lkas" value="true"/>

    <!-- ===============================
         ì°¨ì„  ì´íƒˆ ê¸°ì¤€ (ì¢Œ/ìš° ë¶„ë¦¬)
    =============================== -->
    <param name="depart_threshold_left"  value="0.18"/>
    <param name="clear_threshold_left"   value="0.14"/>

    <param name="depart_threshold_right" value="0.25"/>
    <param name="clear_threshold_right"  value="0.18"/>

    <!-- ===============================
         ì°¨ì„  ë³´ì • gain
    =============================== -->
    <param name="lane_gain_left"  value="1.8"/>
    <param name="lane_gain_right" value="1.3"/>

    <!-- ===============================
         SLAM â†” LKAS í˜¼í•©
    =============================== -->
    <param name="lane_mix" value="0.75"/>

    <!-- ===============================
         Override ë™ìž‘
    =============================== -->
    <param name="keep_forward_in_override" value="true"/>
    <param name="min_forward" value="0.06"/>

    <!-- ===============================
         Angular / Filter
    =============================== -->
    <param name="max_ang" value="0.9"/>
    <param name="deadzone" value="0.04"/>

    <param name="ang_alpha" value="0.65"/>
    <param name="offset_alpha" value="0.70"/>

    <!-- ===============================
         Timeout / Rate
    =============================== -->
    <param name="slam_timeout" value="0.5"/>
    <param name="lane_timeout" value="0.5"/>
    <param name="rate" value="20"/>

    <!-- ===============================
         ðŸŸ¥ MARKER DELAY STOP (í•µì‹¬)
    =============================== -->
    <param name="stop_marker_id" value="0"/>
    <param name="stop_delay"     value="2.0"/>

  </node>

  <!-- ========================================================= -->
  <!-- 6) ROSBRIDGE (Flutter ì•± ì—°ê²°) -->
  <!-- ========================================================= -->
  <node pkg="rosbridge_server"
        type="rosbridge_websocket"
        name="rosbridge_websocket"
        output="screen">
    <param name="port" value="9090"/>
  </node>

  <!-- ========================================================= -->
  <!-- 7) MAP HTTP ì„œë²„ (ì•± ì§€ë„ìš©) -->
  <!-- ========================================================= -->
  <node pkg="limo_slam_lkas"
        type="map_http_server.py"
        name="map_http_server"
        output="screen">
    <param name="map_file" value="$(find limo_bringup)/maps/test_map.yaml"/>
    <param name="port" value="8000"/>
  </node>

  <!-- ========================================================= -->
  <!-- 8) GOAL MANAGER (ì•± ë²„íŠ¼ â†’ move_base goal) -->
  <!-- ========================================================= -->
  <node pkg="limo_slam_lkas"
        type="goal_manager.py"
        name="goal_manager"
        output="screen"
        launch-prefix="bash -c 'sleep 5; exec $0 $@'"/>
</launch>
